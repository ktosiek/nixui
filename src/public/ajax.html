<link rel="import" href="/bower_components/core-ajax/core-ajax.html">
<!-- <script src="/bower_components/basil.js/build/basil.min.js"></script> -->


<polymer-element name="ajax-wrapper" attributes="url params method oncomplete">
<template>
  <core-ajax id="coreajax" url="{{url}}" params='{{params}}'
    method="{{method}}" on-core-response="{{onresponse}}" on-core-error="{{onerror}}">
  </core-ajax>
</template>
<script>
(function() {
  // basil = new window.Basil({});
  Polymer('ajax-wrapper', {
    ready: function() {
      window.onerror = function(message, url, lineNumber) {
        this.fire('core-signal', {name: "message", data: {type: "error", text: message}});
        // returning true will prevent the firing of the default handler, and returning false will let the default handler run
        return false;
      }.bind(this);
    },
    onresponse: function(e) {
      if (this.oncomplete) {
        var o;
        try {
          o = JSON.parse(e.detail.xhr.response);
        } catch (ex) {
          o = e.detail.xhr.response;
        }
        this.oncomplete(o);
      }
    },
    go: function(url, params, method, oncomplete) {
      params = params ? params : (this.params?JSON.parse(this.params):{});
      // access_token = basil.cookie.get("access_token");
      // if (access_token) {
      //   params.access_token = access_token;
      // }

      this.url = url ? url : this.url;
      this.params = JSON.stringify(params);
      this.method = method ? method : this.method;
      this.oncomplete = oncomplete ? oncomplete : this.oncomplete;

      this.$.coreajax.go();
    },
    onerror: function(e) {
      this.fire('core-signal', {name: "message", data: {type: "error", text: e.detail}});
    }
  });
})();
</script>
</polymer-element>


<polymer-element name="ajax-queue">
<template>
  <div id="ajaxqueue"></div>
</template>
<script>
(function() {
  Polymer('ajax-queue', {
    makeid: function() {
      var text = "";
      var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for( var i=0; i < 20; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      return text;
    },
    add: function(url, params, method, oncomplete) {
      var instance = document.createElement('ajax-wrapper');
      instance.setAttribute("id", this.makeid());
      var ajaxqueue = this.$.ajaxqueue;
      ajaxqueue.appendChild(instance);

      instance.go(url, params, method, function(data){
        oncomplete(data);
        ajaxqueue.removeChild(instance);
      }.bind(oncomplete).bind(instance).bind(ajaxqueue));
    }
  });
})();
</script>
</polymer-element>
