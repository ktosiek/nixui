<!doctype html>
<html>

<head>
  <title>NixUI</title>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="/bower_components/platform/platform.js"></script>
  <link rel="import" href="/bower_components/font-roboto/roboto.html">
  <link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
  <link rel="import" href="/bower_components/core-toolbar/core-toolbar.html">
  <link rel="import" href="/bower_components/core-collapse/core-collapse.html">
  <link rel="import" href="/bower_components/core-ajax/core-ajax.html">
  <link rel="import" href="/bower_components/paper-input/paper-input.html">
  <link rel="import" href="/bower_components/paper-ripple/paper-ripple.html">
  <link rel="import" href="/bower_components/core-icon-button/core-icon-button.html">
  <link rel="import" href="/bower_components/core-signals/core-signals.html">
  <link rel="import" href="/bower_components/paper-dialog/paper-dialog-transition.html">
  <link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="/bower_components/paper-button/paper-button.html">
  <link rel="import" href="/bower_components/core-overlay/core-overlay.html">
  <link rel="import" href="/bower_components/paper-progress/paper-progress.html">
  <link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
  <script src="/bower_components/jquery/dist/jquery.js"></script>
  <style>
  html,body {
    height: 100%;
    margin: 0;
    background-color: white;
    font-family: 'RobotoDraft', sans-serif;
  }
  </style>
</head>

<body unresolved touch-action="auto">

  <nixui-body></nixui-body>

</body>

  <polymer-element name="nixui-body">
  <template>
  <style>
  core-header-panel {
    height: 100%;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  query-input {
    font-color: #005aa0;
  }
  core-toolbar {
    background: white;
    fill: #005aa0;
  }
  .nixuicenter {
    color: #005aa0;
    position: relative;
    text-align: center;
  }
  .nixuilink {
    color: #005aa0;
    text-decoration: none;
  }
  #dimmer
  {
      background:#000;
      opacity:0.2;
      position:fixed; /* important to use fixed, not absolute */
      top:0;
      left:0;
      width:100%;
      height:100%;
      display:none;
      z-index:1;
  }
  </style>
  <core-signals on-core-signal-dim="{{dimSignal}}"></core-signals>
  <core-header-panel id="contentpanel" mode="seamed">
    <div id="dimmer"></div>
    <div class="core-header">
      <core-toolbar>
        <div class="nixuicenter">
          <a href="https://github.com/matejc/nixui" class="nixuilink">NixUI<paper-ripple fit></paper-ripple></a>
        </div>
        <div flex></div>
        <query-input></query-input>
        <div flex></div>
        <core-icon-button icon="more-vert"></core-icon-button>
      </core-toolbar>
      <progress-bar><progress-bar>
    </div>

      <list-packages></list-packages>
  </core-header-panel>

  <package-dialog></package-dialog>
  <error-dialog></error-dialog>
  </template>
  <script>
  (function() {

    Polymer('nixui-body', {
      dimSignal: function(e, detail, sender) {
        this.$.dimmer.style.display=(detail)?"block":"none";
      }
    });

  })();
  </script>
  </polymer-element>


  <polymer-element name="query-input" on-keypress="{{keypressHandler}}">
    <template>
      <style type="text/css">
        .iconmiddle {
          vertical-align: middle;
        }
      </style>
      <span>
        <!-- <core-icon-button on-click="{{resetCache}}" icon="refresh"></core-icon-button> -->
        <core-icon-button icon="check"></core-icon-button>
        <paper-input class="iconmiddle" on-keyup="{{keyHandler}}" value="{{value}}" label="Search packages ..."></paper-input>
        <core-icon-button on-click="{{setPackages}}" icon="search"></core-icon-button>
      </span>
    </template>
    <script>
      Polymer('query-input', {
        setPackages: function () {
          this.fire('core-signal', {name: "progress", data: "start"});
          $.ajax({
                  url: '/api/search',
                  data: {
                    'query': this.value
                  },
                  success: function(data) {
                    if (data.error) {
                      this.fire('core-signal', {name: "error", data: data.error});
                    } else {
                      this.fire('core-signal', {name: "query", data: data});
                    }
                    this.fire('core-signal', {name: "progress", data: "finish"});
                  }.bind(this)
                });
        },
        ready: function() {
          this.value = "";
          this.setPackages();
        },
        keyHandler: function(event, detail, sender) {
          if (event.keyCode == 13) {
            this.setPackages();
          }
        },
        resetCache: function() {
          $.ajax({
                  url: '/api/search',
                  type: 'DELETE',
                  success: function(data) {
                    this.setPackages();
                  }.bind(this)
                });
        }
      });
    </script>
  </polymer-element>


  <polymer-element name="list-packages">
  <template>
    <core-signals on-core-signal-query="{{querySignal}}"></core-signals>
    <style>
      .pkgname {
        float: left;
        color: #005aa0;
      }
      .pkgattr {
        float: right;
        text-align: right;
        color: #646464;
      }
      .package {
        position: relative;
        height: 32px;
        line-height: 32px;
        color: #646464;
        padding-right: 0.5em;
        padding-left: 0.5em;
      }
      .package:hover {
        background-color: #eeeeee;
      }
      .uptodate {
        background-color: #bbeeff;
      }
      .different {
        background-color: #bbffee;
      }
      #listcontainer {
        margin-top: 0.5em;
      }
    </style>
    <div id="listcontainer">
    <template repeat="{{package in packages}}" bind="{{classNameFromCompare as classNameFromCompare}}">
      <div on-click="{{openPackageDialog}}" data-pkgattr="{{package.attribute}}" data-pkgname="{{package.name}}" data-pkgcomp="{{package.compare}}" class="package {{package.compare | classNameFromCompare}}">
        <div class="pkgname">{{package.name}}</div>
        <div class="pkgattr">{{package.attribute}}</div>
        <paper-ripple fit></paper-ripple>
      </div>
    </template>
    </div>
  </template>
  <script>
  (function() {
    Polymer('list-packages', {
      classNameFromCompare: function(value) {
        var result = "";
        if (value[0] == "=") {
          result = "uptodate";
        } else if (value[0] in ["<", ">"]) {
          result = "different"
        }
        return result;
      },
      querySignal: function(e, detail, sender) {
        this.packages = detail;
      },
      ready: function() {
        this.packages = [];
      },
      openPackageDialog: function(e, detail, sender) {
        var attribute = sender.getAttribute('data-pkgattr');
        var name = sender.getAttribute('data-pkgname');
        var compare = sender.getAttribute('data-pkgcomp');
        this.fire('core-signal', {name: "pkginfo", data: {pkgattr: attribute, pkgname: name, pkgcomp: compare}});
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="package-dialog">
  <template>
    <core-signals on-core-signal-pkginfo="{{pkginfoSignal}}"></core-signals>
    <style>
    #pkgdialog {
      font-family: 'RobotoDraft', sans-serif;
      font-size: 90%;
      border-style: solid;
      border-width: 2px;
      border-color: #4a9ae0;
    }
    #pkgmark {
      color: {{markobj.color}};
    }
    paper-button {
      color: #646464;
    }
    </style>
    <my-dialog id="pkgdialog" heading="{{pkginfo.name}}" transition="paper-dialog-transition-bottom" closeSelector="[dismissive]">
      <labeled-panel label="Attribute" content="{{packageobj.pkgattr}}"></labeled-panel>
      <labeled-panel label="Path" content="{{pkginfo.path}}"></labeled-panel>

      <labeled-panel label="native Build Inputs" content="{{pkginfo.nativeBuildInputs}}"></labeled-panel>
      <labeled-panel label="propagated Native Build Inputs" content="{{pkginfo.propagatedNativeBuildInputs}}"></labeled-panel>

      <labeled-panel label="Description" content="{{pkginfo.meta.description}}"></labeled-panel>
      <labeled-panel label="Long Description" content="{{pkginfo.meta.longDescription}}"></labeled-panel>

      <labeled-panel label="Maintainers" content="{{pkginfo.meta.maintainers}}"></labeled-panel>

      <paper-button on-keydown="{{closeBtnDown}}" label="Close" dismissive></paper-button>

      <paper-checkbox id="pkgmark" on-click="{{donotclick}}" on-change="{{marked}}" label="{{markobj.label}}" checked="{{markobj.checked}}" affirmative autofocus></paper-checkbox>
    </my-dialog>
  </template>
  <script>
  (function() {
    Polymer('package-dialog', {
      donotclick: function(e, detail, sender) {
        e.stopPropagation();
      },
      markObjects: function() {
        return [
          {name: "installed", label: "Installed!", color: "#005aa0", checked: true},
          {name: "available", label: "Available!", color: "#646464", checked: false},
          {name: "install", label: "Marked for installation!", color: "#00a05a", checked: true},
          {name: "uninstall", label: "Marked for removal!", color: "#a05a00", checked: false},
        ];
      },
      pkginfoSignal: function(e, detail, sender) {
        this.packageobj = detail;
        $.ajax({
                url: '/api/mark',
                data: {
                  'attribute': this.packageobj.pkgattr
                },
                success: function(data) {
                  if (data.error) {
                    this.fire('core-signal', {name: "error", data: data.error});
                    return;
                  }
                  this.markobj = this.getMarkObj(data.mark);
                }.bind(this)
              });
        $.ajax({
                url: '/api/info',
                data: {
                  'attribute': this.packageobj.pkgattr
                },
                success: function(data) {
                  if (data.error) {
                    this.fire('core-signal', {name: "error", data: data.error});
                    return;
                  }
                  this.pkginfo = JSON.parse(data);
                  var dialog = this.$.pkgdialog;
                  dialog.toggle();
                }.bind(this)
              });
      },
      marked: function(e, detail, sender) {
        console.log("clicked:"+this.packageobj.pkgattr);
        $.ajax({
                url: '/api/mark/' + (sender.checked? "install":"uninstall"),
                data: {
                  'attribute': this.packageobj.pkgattr
                },
                success: function(data) {
                  this.markobj = this.getMarkObj(data.mark);
                  console.log(this.markobj);
                }.bind(this)
              });
      },
      closeBtnDown: function(e, detail, sender) {
        if (e.keyCode == 13) {
          this.$.pkgdialog.toggle();
        }
      },
      getMarkObj: function(mark) {
        var markobjects = this.markObjects();
        var _find = function(name) {
          for (var i in markobjects) {
            if (markobjects[i].name == name) {
              return markobjects[i];
            }
          }
        };
        if (mark == "install" || mark == "uninstall") {
          return _find(mark);
        }
        if (this.packageobj.pkgcomp[0] != "-")
          return _find("installed");
        return _find("available");
      },
      ready: function() {
        var emptyInfo = {
          name: "",
          path: "",
          propagatedNativeBuildInputs: [],
          nativeBuildInputs: [],
          meta: {
            description: "",
            longDescription: "",
            maintainers: [],
            position: "",
            homepage: "",
            license: ""
          }
        };
        this.packageobj = {pkgattr: "", pkgname: "", pkgcomp: ""};
        this.pkginfo = emptyInfo;
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="labeled-panel" attributes="label content">
  <template>
    <style>
    #panellabel {
      font-family: 'RobotoDraft', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      font-size: 60%;
      color: #005aa0;
    }
    #panelcontent {
      font-family: 'RobotoDraft', sans-serif;
      color: #646464;
    }
    .hidden {
      display: none;
    }
    .shown {
      padding-top: 0.6em;
    }
    </style>
    <div class="{{emptyEntryClass}}">
      <div id="panellabel">{{label}}</div>
      <div id="panelcontent">{{content | contentToString}}</div>
    </div>
  </template>
  <script>
  (function() {
    Polymer('labeled-panel', {
      contentToString: function(entry) {

        var result = null;

        if (entry instanceof Array) {
          var array = [];
          for (var key in entry) {
            if (entry[key].hasOwnProperty["name"] && typeof entry[key].name == "string") {
              array.push(entry[key].name);
            } else {
              array.push(entry[key]);
            }
          }
          result = array.join(", ");
        } else {
          result = entry;
        }

        if (result) {
          this.emptyEntryClass = "shown";
          return result;
        } else {
          this.emptyEntryClass = "hidden";
          return "";
        }

      },
      ready: function() {
        this.emptyEntryClass = "";
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="error-dialog">
  <template>
    <core-signals on-core-signal-error="{{errorSignal}}"></core-signals>
    <style>
    .errortext {
      color: #880000;
    }
    #errordialog {
      font-family: 'RobotoDraft', sans-serif;
      font-size: 80%;
      background-color: #FFF5F5;
      border-style: solid;
      border-width: 2px;
      border-color: #FF8585;
    }
    paper-shadow {
      display: none;
      z-index: -1;
    }
    </style>
    <my-dialog id="errordialog" heading="Error" transition="paper-dialog-transition-bottom">
      <p class="errortext" on-click="{{selectAll}}">{{errortext}}</p>
      <paper-button label="Close" dismissive></paper-button>
    </my-dialog>
  </template>
  <script>
  (function() {
    Polymer('error-dialog', {
      errorSignal: function(e, detail, sender) {
        this.errortext = detail;
        var dialog = this.$.errordialog;
        dialog.toggle();
      },
      ready: function() {
        this.dialogtext = "N/A";
      },
      selectAll: function() {
        $(".errortext").select();
      }
    });
  })();
  </script>
  </polymer-element>


  <!-- copy of paper-dialog, without shadow -->
  <polymer-element name="my-dialog" attributes="opened heading transition autoCloseDisabled backdrop layered closeSelector" role="dialog">
    <template>
      <style type="text/css">
      :host {
        background: white;
        color: rgba(0, 0, 0, 0.87);
      }
      #container {
        overflow: hidden;
      }
      #main {
        height: auto;
        -webkit-order: 1;
        -ms-flex-order: 1;
        order: 1;
        padding: 24px;
        overflow: auto;
      }
      h1 {
        margin: 0;
      }
      #actions {
        -webkit-order: 2;
        -ms-flex-order: 2;
        order: 2;
        padding: 4px 16px 20px;
      }
      polymer-next-selector { content: ':host > *'; }
      ::content > * {
        font: inherit;
        border: 0;
      }
      </style>
      <core-overlay id="overlay" opened?="{{opened}}" autoCloseDisabled?="{{autoCloseDisabled}}" backdrop?="{{backdrop}}" layered?="{{layered}}" target="{{}}" sizingTarget="{{$.container}}" closeSelector="{{closeSelector}}" transition="{{transition}}" margin="20"></core-overlay>
      <div id="container" layout vertical>
        <div id="actions" layout horizontal>
          <content select="[dismissive]"></content>
          <div flex auto></div>
          <content select="[affirmative]"></content>
        </div>
        <div id="main" flex auto>
          <h1>{{heading}}</h1>
          <content></content>
        </div>
      </div>
    </template>
    <script>
      Polymer('my-dialog', {
        opened: false,
        backdrop: false,
        layered: false,
        autoCloseDisabled: false,
        closeSelector: '[dismissive],[affirmative]',
        heading: '',
        transition: '',
        toggle: function() {
          this.$.overlay.toggle();
        },
        headingChanged: function() {
          this.setAttribute('aria-label', this.heading);
        },
        observeOpened: function(oldValue, newValue) {
          this.fire('core-signal', {name: "dim", data: newValue});
        },
        observe: {
          '$.overlay.opened': 'observeOpened'
        }
      });
    </script>
  </polymer-element>


  <polymer-element name="progress-bar">
  <template>
    <core-signals on-core-signal-progress="{{progressSignal}}"></core-signals>
    <style>
    paper-progress::shadow #activeProgress {
      background-color: #005aa0;
    }
    paper-progress::shadow #progressContainer {
      background-color: #e0e0e0;
    }
    #progressbar {
      display: block;
      width: 100%;
    }
    </style>
    <paper-progress id="progressbar" value="{{position}}"></paper-progress>
  </template>
  <script>
  (function() {
    Polymer('progress-bar', {
      progressSignal: function(e, detail, sender) {
        if (detail == "start")
          this.startProgress();
        else
          this.finishProgress();
      },
      nextProgress: function() {
        if (this.position < 1000) {
          this.position += (this.step || 1);
        } else {
          if (this.animating)
            this.position = 0;
          else
            return;
        }
        this.async(this.nextProgress, null, this.delay);
      },
      startProgress: function() {
        this.position = 0;
        this.step = 5;
        if (!this.animating) {
          this.delay = 200;
          this.animating = true;
          this.nextProgress();
        }
      },
      ready: function() {
        this.$.progressbar.max = 1000;
        this.startProgress();
      },
      finishProgress: function() {
        this.step = 50;
        this.delay = 10;
        this.animating = false;
      }
    });
  })();
  </script>
  </polymer-element>


</html>
