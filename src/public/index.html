<!doctype html>
<html>

<head>
  <title>NixUI</title>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="/bower_components/platform/platform.js"></script>
  <link rel="import" href="/bower_components/font-roboto/roboto.html">
  <link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
  <link rel="import" href="/bower_components/core-toolbar/core-toolbar.html">
  <link rel="import" href="/bower_components/core-collapse/core-collapse.html">
  <link rel="import" href="/bower_components/core-ajax/core-ajax.html">
  <link rel="import" href="/bower_components/paper-input/paper-input.html">
  <link rel="import" href="/bower_components/paper-ripple/paper-ripple.html">
  <link rel="import" href="/bower_components/core-icon-button/core-icon-button.html">
  <link rel="import" href="/bower_components/core-signals/core-signals.html">
  <link rel="import" href="/bower_components/paper-dialog/paper-dialog-transition.html">
  <link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="/bower_components/paper-button/paper-button.html">
  <link rel="import" href="/bower_components/core-overlay/core-overlay.html">
  <link rel="import" href="/bower_components/paper-progress/paper-progress.html">
  <link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
  <link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
  <link rel="import" href="/bower_components/paper-item/paper-item.html">
  <style>
  html,body {
    height: 100%;
    margin: 0;
    background-color: white;
    font-family: 'RobotoDraft', sans-serif;
  }
  </style>
</head>

<body unresolved touch-action="auto">

  <nixui-body></nixui-body>

</body>

  <polymer-element name="nixui-body">
  <template>
  <style>
  core-header-panel {
    height: 100%;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  core-toolbar {
    background: white;
    fill: #005aa0;
  }
  .nixuicenter {
    color: #005aa0;
    position: relative;
    text-align: center;
  }
  .nixuilink {
    color: #005aa0;
    text-decoration: none;
  }
  #dimmer
  {
      background:#000;
      opacity:0.2;
      position:fixed; /* important to use fixed, not absolute */
      top:0;
      left:0;
      width:100%;
      height:100%;
      display:none;
      z-index:1;
  }
  paper-menu-button {
    color: #005aa0;
  }
  paper-item {
    margin: 0.5em;
    font-size: 80%;
  }
  </style>
  <core-signals on-core-signal-dim="{{dimSignal}}"></core-signals>
  <core-signals on-core-signal-resetcache="{{resetCache}}"></core-signals>
  <core-header-panel id="contentpanel" mode="seamed">
    <div id="dimmer"></div>
    <div class="core-header">
      <core-toolbar>
        <div class="nixuicenter">
          <a href="https://github.com/matejc/nixui" class="nixuilink">NixUI<paper-ripple fit></paper-ripple></a>
        </div>
        <div flex></div>
        <query-input id="queryfield" query="{{query}}"></query-input>
        <div flex></div>
        <paper-menu-button icon="more-vert" halign="right" valign="bottom">
          <paper-item on-click="{{searchFor}}" data-query="!i" label="Search installed"></paper-item>
          <paper-item on-click="{{searchFor}}" data-query="!u" label="Search upgradeable"></paper-item>
          <paper-item on-click="{{openMarkedDialog}}" label="Manage marked ..."></paper-item>
          <paper-item on-click="{{resetCache}}" label="Reset Search Cache"></paper-item>
        </paper-menu-button>
      </core-toolbar>
      <progress-bar><progress-bar>
    </div>

    <list-packages></list-packages>
  </core-header-panel>

  <package-dialog controlDim="true"></package-dialog>
  <error-dialog controlDim="true"></error-dialog>
  <marked-dialog controlDim="true"></marked-dialog>

  <ajax-wrapper id="ajax"></ajax-wrapper>
  </template>
  <script>
  (function() {

    Polymer('nixui-body', {
      dimSignal: function(e, detail, sender) {
        this.$.dimmer.style.display=(detail)?"block":"none";
      },
      searchFor: function(e, detail, sender) {
        this.query = sender.getAttribute("data-query");
      },
      openMarkedDialog: function(e, detail, sender) {
        this.fire('core-signal', {name: "openmarked"});
      },
      resetCache: function() {
        this.$.ajax.go("/api/search", null, "DELETE", function(data) {
          this.$.queryfield.setPackages();
        }.bind(this));
        // $.ajax({
        //         url: '/api/search',
        //         type: 'DELETE',
        //         success: function(data) {
        //           this.$.queryfield.setPackages();
        //         }.bind(this)
        //       });
      },
    });

  })();
  </script>
  </polymer-element>


  <polymer-element name="ajax-wrapper" attributes="url params method oncomplete">
  <template>
    <core-ajax id="coreajax" url="{{url}}" params='{{params}}'
      method={{method}} on-core-complete={{complete}}>
    </core-ajax>
  </template>
  <script>
  (function() {
    Polymer('ajax-wrapper', {
      complete: function(e) {
        if (this.oncomplete)
          this.oncomplete(JSON.parse(e.detail.xhr.response));
      },
      go: function(url, params, method, oncomplete) {
        this.url = url ? url : this.url;
        this.params = params ? JSON.stringify(params) : this.params;
        this.method = method ? method : this.method;
        this.oncomplete = oncomplete ? oncomplete : this.oncomplete;

        this.$.coreajax.go();
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="ajax-queue">
  <template>
    <div id="ajaxqueue"></div>
  </template>
  <script>
  (function() {
    Polymer('ajax-queue', {
      makeid: function() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for( var i=0; i < 20; i++ )
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
      },
      add: function(url, params, method, oncomplete) {
        var instance = document.createElement('ajax-wrapper');
        instance.setAttribute("id", this.makeid());
        var ajaxqueue = this.$.ajaxqueue;
        ajaxqueue.appendChild(instance);

        instance.go(url, params, method, function(data){
          oncomplete(data);
          ajaxqueue.removeChild(instance);
        }.bind(oncomplete).bind(instance).bind(ajaxqueue));
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="query-input" attributes="query" on-keypress="{{keypressHandler}}">
    <template>
      <style type="text/css">
        #searchfield {
          top: 0.4em;
          vertical-align: middle;
        }
        core-icon-button {
          color: #005aa0;
        }
      </style>
      <span>
        <paper-input id="searchfield" on-keyup="{{keyHandler}}" value="{{value}}" label="Search packages ..."></paper-input>
        <core-icon-button on-click="{{setPackages}}" icon="search"></core-icon-button>
      </span>
      <ajax-queue id="ajax"></ajax-queue>
    </template>
    <script>
    (function() {
      Polymer('query-input', {
        setPackages: function () {
          this.fire('core-signal', {name: "progress", data: "start"});
          this.$.ajax.add("/api/search", {
            'query': this.value
          }, "GET", function(data) {
            if (data.error) {
              this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: true}});
            } else {
              this.fire('core-signal', {name: "query", data: data});
            }
            this.fire('core-signal', {name: "progress", data: "finish"});
          }.bind(this));
        },
        ready: function() {
          this.value = "";
          setTimeout(this.setPackages.bind(this), 1);
        },
        keyHandler: function(event, detail, sender) {
          if (event.keyCode == 13) {
            this.setPackages();
          }
        },
        queryChanged: function() {
          if (this.query) {
            this.value = this.query;
            this.setPackages();
            this.query = "";  // unset so that next time change is detected
          }
        }
      });
    })();
    </script>
  </polymer-element>


  <polymer-element name="list-packages">
  <template>
    <core-signals on-core-signal-query="{{querySignal}}"></core-signals>
    <style>
      .pkgname {
        float: left;
        color: #005aa0;
      }
      .pkgattr {
        float: right;
        text-align: right;
        color: #646464;
      }
      .pkgstate {
        float: left;
        font-family: 'RobotoDraft', sans-serif;
        text-transform: uppercase;
        font-weight: bold;
        font-size: 60%;
        margin-left: 2em;
      }
      .package {
        position: relative;
        height: 32px;
        line-height: 32px;
        color: #646464;
        padding-right: 0.5em;
        padding-left: 0.5em;
      }
      .package:hover {
        background-color: #eeeeee;
      }
      .available {
        display:none;
      }
      .uptodate {
        display: block;
        color: #00a05a;
      }
      .different {
        display: block;
        color: #a05a5a;
      }
    </style>
    <div id="listcontainer">
    <template repeat="{{package in packages}}" bind="{{classNameFromCompare as classNameFromCompare}}">
      <div on-click="{{openPackageDialog}}" data-pkgattr="{{package.attribute}}" data-pkgname="{{package.name}}" data-pkgcomp="{{package.compare}}" class="package">
        <div class="pkgname">{{package.name}}</div>
        <div class="pkgstate {{package.compare | classNameFromCompare}}" class="pkgstate">{{package.compare}}</div>
        <div class="pkgattr">{{package.attribute}}</div>
        <paper-ripple fit></paper-ripple>
      </div>
    </template>
    </div>
  </template>
  <script>
  (function() {
    Polymer('list-packages', {
      classNameFromCompare: function(value) {
        var result = "";
        switch (value[0]) {
          case "-":
            result = "available";
            break;
          case "=":
            result = "uptodate";
            break;
          case "<":
          case ">":
            result = "different";
        }
        return result;
      },
      querySignal: function(e, detail, sender) {
        this.packages = detail;
      },
      ready: function() {
        this.packages = [];
      },
      openPackageDialog: function(e, detail, sender) {
        var attribute = sender.getAttribute('data-pkgattr');
        var name = sender.getAttribute('data-pkgname');
        var compare = sender.getAttribute('data-pkgcomp');
        this.fire('core-signal', {name: "pkginfo", data: {pkgattr: attribute, pkgname: name, pkgcomp: compare, controlDim: true}});
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="package-dialog" attributes="controlDim">
  <template>
    <core-signals on-core-signal-pkginfo="{{pkginfoSignal}}"></core-signals>
    <style>
    #pkgdialog {
      font-family: 'RobotoDraft', sans-serif;
      font-size: 90%;
      border-style: solid;
      border-width: 2px;
      border-color: #4a9ae0;
      left: 3em;
      right: 3em;
    }
    #pkgmark {
      color: {{markobj.color}};
    }
    paper-button {
      color: #646464;
    }
    </style>
    <my-dialog id="pkgdialog" heading="{{pkginfo.name}}" transition="paper-dialog-transition-bottom" controlDim="{{controlDim}}" closeSelector="[dismissive]">
      <labeled-panel label="Attribute" content="{{signalobj.pkgattr}}"></labeled-panel>
      <labeled-panel label="Path" content="{{pkginfo.path}}"></labeled-panel>

      <labeled-panel label="native Build Inputs" content="{{pkginfo.nativeBuildInputs}}"></labeled-panel>
      <labeled-panel label="propagated Native Build Inputs" content="{{pkginfo.propagatedNativeBuildInputs}}"></labeled-panel>

      <labeled-panel label="Description" content="{{pkginfo.meta.description}}"></labeled-panel>
      <labeled-panel label="Long Description" content="{{pkginfo.meta.longDescription}}"></labeled-panel>

      <labeled-panel label="Maintainers" content="{{pkginfo.meta.maintainers}}"></labeled-panel>

      <paper-button on-keydown="{{closeBtnDown}}" label="Close" dismissive></paper-button>

      <paper-checkbox id="pkgmark" on-click="{{donotclick}}" on-change="{{marked}}" label="{{markobj.label}}" checked="{{markobj.checked}}" affirmative autofocus></paper-checkbox>
    </my-dialog>
    <ajax-queue id="ajax"></ajax-queue>
  </template>
  <script>
  (function() {
    Polymer('package-dialog', {
      donotclick: function(e, detail, sender) {
        e.stopPropagation();
      },
      markObjects: function() {
        return [
          {name: "installed", label: "Installed!", color: "#005aa0", checked: true},
          {name: "available", label: "Available!", color: "#646464", checked: false},
          {name: "install", label: "Marked for installation!", color: "#00a05a", checked: true},
          {name: "uninstall", label: "Marked for removal!", color: "#a05a00", checked: false},
        ];
      },
      toggle: function() {
        this.$.pkgdialog.controlDim = this.signalobj.controlDim;
        this.$.pkgdialog.toggle();
      },
      pkginfoSignal: function(e, detail, sender) {
        this.signalobj = detail;
        this.$.ajax.add("/api/mark", {
          'attribute': this.signalobj.pkgattr
        }, "GET", function(data) {
          if (data.error) {
            this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: true}});
            return;
          }
          this.markobj = this.getMarkObj(data.mark);
        }.bind(this));

        this.$.ajax.add("/api/info", {
          'attribute': this.signalobj.pkgattr
        }, "GET", function(data) {
          if (data.error) {
            this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: true}});
            return;
          }
          this.pkginfo = data;
          this.toggle();
        }.bind(this));
      },
      marked: function(e, detail, sender) {
        this.$.ajax.add('/api/mark/' + (sender.checked? "install":"uninstall"), {
          'attribute': this.signalobj.pkgattr
        }, "GET", function(data) {
          this.markobj = this.getMarkObj(data.mark);
        }.bind(this));
      },
      closeBtnDown: function(e, detail, sender) {
        if (e.keyCode == 13) {
          this.toggle();
        }
      },
      getMarkObj: function(mark) {
        var markobjects = this.markObjects();
        var _find = function(name) {
          for (var i in markobjects) {
            if (markobjects[i].name == name) {
              return markobjects[i];
            }
          }
        };
        if (mark == "install" || mark == "uninstall") {
          return _find(mark);
        }
        if (this.signalobj.pkgcomp[0] != "-")
          return _find("installed");
        return _find("available");
      },
      ready: function() {
        var emptyInfo = {
          name: "",
          path: "",
          propagatedNativeBuildInputs: [],
          nativeBuildInputs: [],
          meta: {
            description: "",
            longDescription: "",
            maintainers: [],
            position: "",
            homepage: "",
            license: ""
          }
        };
        this.signalobj = {pkgattr: "", pkgname: "", pkgcomp: "", controlDim: false};
        this.pkginfo = emptyInfo;
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="labeled-panel" attributes="label content">
  <template>
    <style>
    #panellabel {
      font-family: 'RobotoDraft', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      font-size: 60%;
      color: #005aa0;
    }
    #panelcontent {
      font-family: 'RobotoDraft', sans-serif;
      color: #646464;
    }
    .hidden {
      display: none;
    }
    .shown {
      padding-top: 0.6em;
    }
    </style>
    <div class="{{emptyEntryClass}}">
      <div id="panellabel">{{label}}</div>
      <div id="panelcontent">{{content | contentToString}}</div>
    </div>
  </template>
  <script>
  (function() {
    Polymer('labeled-panel', {
      contentToString: function(entry) {

        var result = null;

        if (entry instanceof Array) {
          var array = [];
          for (var key in entry) {
            if (entry[key].hasOwnProperty["name"] && typeof entry[key].name == "string") {
              array.push(entry[key].name);
            } else {
              array.push(entry[key]);
            }
          }
          result = array.join(", ");
        } else {
          result = entry;
        }

        if (result) {
          this.emptyEntryClass = "shown";
          return result;
        } else {
          this.emptyEntryClass = "hidden";
          return "";
        }

      },
      ready: function() {
        this.emptyEntryClass = "";
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="error-dialog" attributes="controlDim">
  <template>
    <core-signals on-core-signal-error="{{errorSignal}}"></core-signals>
    <style>
    .errortext {
      color: #880000;
    }
    #errordialog {
      font-family: 'RobotoDraft', sans-serif;
      font-size: 80%;
      background-color: #FFF5F5;
      border-style: solid;
      border-width: 2px;
      border-color: #FF8585;
      left: 2em;
      right: 2em;
    }
    paper-shadow {
      display: none;
      z-index: -1;
    }
    </style>
    <my-dialog id="errordialog" heading="Error" controlDim="{{controlDim}}" transition="paper-dialog-transition-bottom">
      <p class="errortext" on-click="{{selectAll}}">{{signalobj.text}}</p>
      <paper-button label="Close" dismissive></paper-button>
    </my-dialog>
  </template>
  <script>
  (function() {
    Polymer('error-dialog', {
      errorSignal: function(e, detail, sender) {
        this.signalobj = detail;
        this.toggle();
      },
      toggle: function() {
        this.$.errordialog.controlDim = this.signalobj.controlDim;
        this.$.errordialog.toggle();
      },
      ready: function() {
        this.signalobj = {text: "", controlDim: false};
      },
      selectAll: function() {
        $(".errortext").select();
      }
    });
  })();
  </script>
  </polymer-element>


  <!-- copy of paper-dialog, without shadow with dimming support -->
  <polymer-element name="my-dialog" attributes="opened heading transition autoCloseDisabled backdrop layered closeSelector controlDim" role="dialog">
    <template>
      <style type="text/css">
      :host {
        background: white;
        color: rgba(0, 0, 0, 0.87);
      }
      #container {
        overflow: hidden;
      }
      #main {
        height: auto;
        -webkit-order: 1;
        -ms-flex-order: 1;
        order: 1;
        padding: 24px;
        overflow: auto;
      }
      h1 {
        margin: 0;
      }
      #actions {
        -webkit-order: 2;
        -ms-flex-order: 2;
        order: 2;
        padding: 4px 16px 20px;
      }
      polymer-next-selector { content: ':host > *'; }
      ::content > * {
        font: inherit;
        border: 0;
      }
      </style>
      <core-overlay id="overlay" opened?="{{opened}}" autoCloseDisabled?="{{autoCloseDisabled}}" backdrop?="{{backdrop}}" layered?="{{layered}}" target="{{}}" sizingTarget="{{$.container}}" closeSelector="{{closeSelector}}" transition="{{transition}}" margin="20"></core-overlay>
      <div id="container" layout vertical>
        <div id="actions" layout horizontal>
          <content select="[dismissive]"></content>
          <div flex auto></div>
          <content select="[affirmative]"></content>
        </div>
        <div id="main" flex auto>
          <h1>{{heading}}</h1>
          <content></content>
        </div>
      </div>
    </template>
    <script>
      Polymer('my-dialog', {
        opened: false,
        backdrop: false,
        layered: false,
        autoCloseDisabled: false,
        closeSelector: '[dismissive],[affirmative]',
        heading: '',
        transition: '',
        controlDim: false,
        toggle: function() {
          this.$.overlay.toggle();
        },
        headingChanged: function() {
          this.setAttribute('aria-label', this.heading);
        },
        observeOpened: function(oldValue, newValue) {
          if (this.controlDim) {
            this.fire('core-signal', {name: "dim", data: newValue});
          }
        },
        observe: {
          '$.overlay.opened': 'observeOpened'
        }
      });
    </script>
  </polymer-element>


  <polymer-element name="progress-bar" attributes="progress progressFromSignal">
  <template>
    <core-signals on-core-signal-progress="{{progressSignal}}"></core-signals>
    <style>
    paper-progress::shadow #activeProgress {
      background-color: {{progressColor}};
    }
    paper-progress::shadow #progressContainer {
      background-color: #e0e0e0;
    }
    #progressbar {
      display: block;
      width: 100%;
    }
    </style>
    <paper-progress id="progressbar" value="{{position}}" max="1000"></paper-progress>
  </template>
  <script>
  (function() {
    Polymer('progress-bar', {
      progressSignal: function(e, detail, sender) {
        if (!this.progressFromSignal)
          return;
        this.doProgress(detail)
      },
      progressChanged: function() {
        if (this.progressFromSignal)
          return;
        this.doProgress(this.progress)
      },
      nextProgress: function() {
        if (this.position < 1000) {
          this.position += (this.step || 1);
        } else {
          if (this.animating)
            this.position = 0;
          else
            return;
        }
        this.async(this.nextProgress, null, this.delay);
      },
      doProgress: function(command) {
        switch (command) {
          case "start":
            this.startProgress();
            break;
          case "finish":
            this.finishProgress();
            break;
          case "wait":
            this.waitProgress();
            break;
          case "error":
            this.errorProgress();
            break;
        }
      },
      waitProgress: function() {
        this.animating = false;
      },
      startProgress: function() {
        this.position = 0;
        this.step = 5;
        this.progressColor = "#00a05a";
        if (!this.animating) {
          this.delay = 200;
          this.animating = true;
          this.nextProgress();
        }
      },
      ready: function() {
        this.progressFromSignal = true,
        this.progressColor = "#00a05a",
        this.progress = "wait",
        this.doProgress(this.progress);
      },
      finishProgress: function() {
        this.step = 50;
        this.delay = 10;
        this.progressColor = "#005aa0";
        if (this.animating)
          this.animating = false;
        else {
          this.animating = false;
          this.nextProgress();
        }
      },
      errorProgress: function() {
        this.step = 50;
        this.delay = 10;
        this.progressColor = "#a05a5a";
        if (this.animating)
          this.animating = false;
        else {
          this.animating = false;
          this.nextProgress();
        }
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="marked-dialog" attributes="controlDim">
  <template>
    <core-signals on-core-signal-openmarked="{{openMarkedSignal}}"></core-signals>
    <style>
    #dialog {
      font-family: 'RobotoDraft', sans-serif;
      font-size: 90%;
      border-style: solid;
      border-width: 2px;
      border-color: #4a9ae0;
      top: 2em;
      bottom: 2em;
      right: 2em;
      left: 2em;
    }
    paper-button {
      color: #646464;
    }
    </style>
    <my-dialog id="dialog" heading="Manage Marked" autoCloseDisabled="true" controlDim="{{controlDim}}" transition="paper-dialog-transition-bottom" closeSelector="[dismissive]">
      <list-marked id="listmarked"></list-marked>
      <paper-button on-keydown="{{closeBtnDown}}" label="Close" dismissive></paper-button>
      <paper-button on-click="{{clearAll}}" label="Clear All" affirmative></paper-button>
      <paper-button on-click="{{applyAll}}" label="Apply All" affirmative></paper-button>
    </my-dialog>
    <ajax-queue id="ajax"></ajax-queue>
  </template>
  <script>
  (function() {
    Polymer('marked-dialog', {
      openMarkedSignal: function(e, detail, sender) {
        this.$.listmarked.setList(function() {
          var dialog = this.$.dialog;
          dialog.toggle();
        }.bind(this));
      },
      closeBtnDown: function(e, detail, sender) {
        if (e.keyCode == 13) {
          this.$.dialog.toggle();
        }
      },
      applyAll: function() {
        this.$.listmarked.applyAll();
      },
      clearAll: function() {
        this.$.ajax.add('/api/mark/list', null, "DELETE", function(data) {
          this.$.dialog.toggle();
        }.bind(this));
      }
    });
  })();
  </script>
  </polymer-element>


  <polymer-element name="list-marked" attributes="list">
  <template>
    <style>
      thead tr td {
        font-family: 'RobotoDraft', sans-serif;
        text-transform: uppercase;
        font-weight: bold;
        font-size: 70%;
        color: #005aa0;
      }
      .package {
        position: relative;
        color: #646464;
        padding-right: 0.5em;
        padding-left: 0.5em;
        height: 100%;
      }
      .package:hover {
        background-color: #eeeeee;
      }
      .center {
        text-align: center;
      }
      .right {
        float: right;
      }
      table {
        margin-top: 0.5em;
        width: 100%;
        border-spacing: 0px;
      }
    </style>
    <div id="listcontainer">

    <table>
      <thead>
        <tr>
          <td>Name</td>
          <td>Attribute</td>
          <td>Marked for</td>
          <td></td>
          <td class="right">Options</td>
        </tr>
      </thead>
      <tbody>
        <template repeat="{{entry in list}}">
          <tr class="package">
            <td class="pkgname">{{entry.name}}</td>
            <td class="pkgattr">{{entry.attribute}}</td>
            <td>{{entry.mark}}</td>
            <td style="width:100px;">
              <progress-bar progressFromSignal="false" progress="{{entry.progress}}"><progress-bar>
            </td>
            <td class="right" data-pkgattr="{{entry.attribute}}" data-pkgname="{{entry.name}}" data-pkgcomp="{{entry.compare}}" data-pkgmark="{{entry.mark}}">
              <core-icon-button on-click="{{onApplyClick}}" icon="check"></core-icon-button>
              <core-icon-button on-click="{{onRemoveClick}}" icon="clear"></core-icon-button>
            </td>
          </tr>
          <tr>
            <td colspan="4">
            </td>
          </tr>
        </template>
      </tbody>
    </table>
    </div>
    <ajax-queue id="ajax"></ajax-queue>
  </template>
  <script>
  (function() {
    Polymer('list-marked', {
      setList: function(callback) {
        this.$.ajax.add('/api/mark/list', null, "GET", function(data) {
          if (data.error) {
            this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: false}});
            return;
          }
          this.list = data;
          if (callback)
            callback(data);
        }.bind(this));
      },
      retryUntilStart: function(attribute) {
        this.setList(function(list) {
          for (var i in list) {
            if (attribute && (attribute == list[i].attribute && list[i].progress == "wait")) {
              setTimeout(function(){this.retryUntilStart(attribute);}.bind(this).bind(attribute), 1000);
              break;
            } else if (list[i].progress == "wait") {
              setTimeout(function(){this.retryUntilStart();}.bind(this), 1000);
              break;
            }
          }
        }.bind(this).bind(attribute));
      },
      applyAll: function() {
        this.retryUntilStart();
        this.$.ajax.add('/api/mark/apply', null, "GET", function(data) {
          this.setList();
          if (data.error) {
            this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: false}});
            return;
          }
          this.fire('core-signal', {name: "resetcache"});
        }.bind(this));
      },
      onApplyClick: function(e) {
        var attr = e.target.parentNode.getAttribute("data-pkgattr");
        this.retryUntilStart(attr);
        this.$.ajax.add('/api/mark/apply', {
          "attribute": attr
        }, "GET", function(data) {
          this.setList();
          if (data.error) {
            this.fire('core-signal', {name: "error", data: {text: data.error, controlDim: false}});
            return;
          }
          this.fire('core-signal', {name: "resetcache"});
        }.bind(this));
      },
      onRemoveClick: function(e) {
        this.$.ajax.add('/api/mark/delete', {
          "attribute": e.target.parentNode.getAttribute("data-pkgattr")
        }, "GET", function(data) {
          if (data.removed)
            this.setList();
        }.bind(this));
      }
    });
  })();
  </script>
  </polymer-element>


</html>
